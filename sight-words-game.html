<!DOCTYPE html>
<html lang="en-IN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sight Words Game for Jammy</title>

    <!--
    ========================================
    SIGHT WORDS LEARNING GAME
    ========================================

    HOW TO USE:
    1. Open this file in Chrome on your Samsung tablet
    2. Tap "Go Full Screen" for best experience
    3. Enable sound by tapping the screen (required by browsers)
    4. Navigate through Teaching mode, then switch to Practice mode

    HOW TO CUSTOMIZE:
    - Replace image placeholders in the ASSETS section below
    - Modify sight words and content in the gameData object (around line 600)
    - Adjust colors and sizes in the CSS section below

    REQUIRED ASSETS (place in same folder as this HTML file):
    Images: bottle.png, cat.png, boy_playing.png, ball.png, boy_happy.png, apple.png
            (or any descriptive images for your sentences)
    Audio: celebration.mp3, try-again.mp3 (optional - will use WebAudio if not present)

    ========================================
    -->

    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Arial Rounded MT Bold', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        /* ===== CONTAINER ===== */
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: clamp(24px, 5vw, 36px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-icon {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            touch-action: manipulation;
        }

        .btn-icon:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.4);
        }

        /* ===== MODE SWITCHER ===== */
        .mode-switcher {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
            flex-shrink: 0;
        }

        .mode-btn {
            flex: 1;
            padding: 15px 25px;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #e0e0e0;
            color: #666;
            touch-action: manipulation;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }

        .mode-btn:active {
            transform: scale(0.98);
        }

        /* ===== MAIN CONTENT AREA ===== */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* ===== TEACHING MODE ===== */
        .teaching-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
        }

        .progress-indicator {
            font-size: clamp(16px, 3vw, 20px);
            color: #666;
            font-weight: bold;
        }

        .image-container {
            width: 90%;
            max-width: 500px;
            aspect-ratio: 4/3;
            background: #f0f0f0;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-placeholder {
            font-size: clamp(18px, 4vw, 24px);
            color: #999;
            text-align: center;
            padding: 20px;
        }

        .sentence-container {
            width: 90%;
            max-width: 700px;
            background: #fff8e1;
            border: 4px solid #ffd54f;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .sentence-text {
            font-size: clamp(32px, 6vw, 56px);
            line-height: 1.4;
            font-weight: bold;
            color: #333;
        }

        .sight-word {
            color: #e91e63;
            text-decoration: underline;
            text-decoration-thickness: 4px;
            text-underline-offset: 6px;
            text-decoration-color: #e91e63;
            padding: 0 4px;
        }

        .audio-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .btn-audio {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            font-size: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .btn-audio:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .navigation-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .btn-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .btn-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-nav:active:not(:disabled) {
            transform: scale(0.95);
        }

        /* ===== PRACTICE MODE ===== */
        .practice-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
        }

        .question-container {
            width: 90%;
            max-width: 700px;
            background: #e3f2fd;
            border: 4px solid #64b5f6;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: clamp(28px, 5vw, 44px);
            line-height: 1.4;
            font-weight: bold;
            color: #1565c0;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            width: 90%;
            max-width: 700px;
            margin-top: 20px;
        }

        .option-btn {
            min-width: 150px;
            padding: 20px 35px;
            font-size: clamp(28px, 5vw, 48px);
            font-weight: bold;
            border: 4px solid #333;
            border-radius: 20px;
            cursor: pointer;
            background: white;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            touch-action: manipulation;
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .option-btn.correct {
            background: #4caf50;
            color: white;
            border-color: #388e3c;
            animation: pulseGreen 0.6s ease;
        }

        .option-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #d32f2f;
            animation: shake 0.5s ease;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        @keyframes pulseGreen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ===== FEEDBACK ===== */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .feedback-overlay.show {
            display: flex;
        }

        .feedback-content {
            background: white;
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 12px 36px rgba(0,0,0,0.3);
            max-width: 80%;
            animation: bounceIn 0.5s ease;
        }

        .feedback-emoji {
            font-size: 120px;
            margin-bottom: 20px;
        }

        .feedback-text {
            font-size: clamp(36px, 7vw, 64px);
            font-weight: bold;
            color: #333;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ===== CONFETTI CANVAS ===== */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* ===== PROGRESS SUMMARY ===== */
        .summary-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 30px;
            padding: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        .summary-title {
            font-size: clamp(32px, 6vw, 48px);
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .summary-stats {
            font-size: clamp(24px, 5vw, 36px);
            color: #333;
            margin: 15px 0;
        }

        .btn-large {
            padding: 20px 40px;
            font-size: clamp(24px, 5vw, 32px);
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin-top: 20px;
            touch-action: manipulation;
        }

        .btn-large:active {
            transform: scale(0.98);
        }

        /* ===== ACCESSIBILITY ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .mode-switcher {
                padding: 10px 15px;
            }

            .content {
                padding: 15px;
            }

            .options-container {
                gap: 10px;
            }

            .option-btn {
                min-width: 120px;
                padding: 15px 25px;
            }
        }

        @media (orientation: landscape) {
            .teaching-view, .practice-view {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center;
            }

            .image-container {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Game Container -->
    <div class="game-container">
        <!-- Header -->
        <header class="header">
            <h1>üåü Sight Words üåü</h1>
            <div class="header-controls">
                <button class="btn-icon" id="muteBtn" title="Toggle Sound" aria-label="Toggle sound">üîä</button>
                <button class="btn-icon" id="fullscreenBtn" title="Go Fullscreen" aria-label="Go fullscreen">‚õ∂</button>
            </div>
        </header>

        <!-- Mode Switcher -->
        <div class="mode-switcher">
            <button class="mode-btn active" id="teachingModeBtn" aria-label="Switch to teaching mode">
                üìö Teaching
            </button>
            <button class="mode-btn" id="practiceModeBtn" aria-label="Switch to practice mode">
                ‚úèÔ∏è Practice
            </button>
            <button class="mode-btn" id="summaryModeBtn" aria-label="View progress summary">
                üìä Progress
            </button>
        </div>

        <!-- Main Content Area -->
        <main class="content" id="mainContent">
            <!-- Content will be dynamically inserted here -->
        </main>

        <!-- Confetti Canvas -->
        <canvas id="confettiCanvas"></canvas>

        <!-- Feedback Overlay -->
        <div class="feedback-overlay" id="feedbackOverlay">
            <div class="feedback-content">
                <div class="feedback-emoji" id="feedbackEmoji">üòä</div>
                <div class="feedback-text" id="feedbackText">Great job, Jammy!</div>
            </div>
        </div>

        <!-- Screen Reader Announcements -->
        <div class="sr-only" aria-live="polite" aria-atomic="true" id="ariaLive"></div>
    </div>

    <script>
        // ========================================
        // GAME DATA & CONFIGURATION
        // ========================================

        const gameData = {
            sightWords: ['is', 'it', 'in', 'on', 'am', 'an'],

            lessons: [
                // Lesson 1: "is"
                {
                    sightWord: 'is',
                    image: 'boy_playing.svg', // TODO: Replace with actual image path
                    imageAlt: 'A boy playing with toys',
                    sentence: 'The boy is playing.',
                    question: 'What is the boy doing?',
                    correctAnswer: 'is',
                    options: ['is', 'in', 'on']
                },
                {
                    sightWord: 'is',
                    image: 'bottle.svg',
                    imageAlt: 'A bottle on a table',
                    sentence: 'The bottle is on the table.',
                    question: 'Where is the bottle?',
                    correctAnswer: 'on',
                    options: ['on', 'in', 'is']
                },
                {
                    sightWord: 'is',
                    image: 'cat.svg',
                    imageAlt: 'A cat sleeping',
                    sentence: 'The cat is sleeping.',
                    question: 'What is the cat doing?',
                    correctAnswer: 'is',
                    options: ['is', 'it', 'in']
                },

                // Lesson 2: "on"
                {
                    sightWord: 'on',
                    image: 'bottle.svg',
                    imageAlt: 'A bottle on a table',
                    sentence: 'The bottle is on the table.',
                    question: 'Where is the bottle?',
                    correctAnswer: 'on',
                    options: ['on', 'in', 'is']
                },
                {
                    sightWord: 'on',
                    image: 'boy_playing.svg',
                    imageAlt: 'A book on a desk',
                    sentence: 'The book is on the desk.',
                    question: 'Where is the book?',
                    correctAnswer: 'on',
                    options: ['on', 'in', 'it']
                },

                // Lesson 3: "in"
                {
                    sightWord: 'in',
                    image: 'cat.svg',
                    imageAlt: 'A cat in a box',
                    sentence: 'The cat is in the box.',
                    question: 'Where is the cat?',
                    correctAnswer: 'in',
                    options: ['in', 'on', 'is']
                },
                {
                    sightWord: 'in',
                    image: 'boy_happy.svg',
                    imageAlt: 'Toys in a basket',
                    sentence: 'The toys are in the basket.',
                    question: 'Where are the toys?',
                    correctAnswer: 'in',
                    options: ['in', 'on', 'it']
                },

                // Lesson 4: "it"
                {
                    sightWord: 'it',
                    image: 'ball.svg',
                    imageAlt: 'A red ball',
                    sentence: 'It is red.',
                    question: 'Which word refers to the thing?',
                    correctAnswer: 'it',
                    options: ['it', 'is', 'in']
                },
                {
                    sightWord: 'it',
                    image: 'ball.svg',
                    imageAlt: 'A ball',
                    sentence: 'I like it.',
                    question: 'Which word refers to the ball?',
                    correctAnswer: 'it',
                    options: ['it', 'is', 'in']
                },

                // Lesson 5: "am"
                {
                    sightWord: 'am',
                    image: 'boy_happy.svg',
                    imageAlt: 'A happy boy with hand up',
                    sentence: 'I am happy.',
                    question: 'Which word shows I feel something?',
                    correctAnswer: 'am',
                    options: ['am', 'is', 'an']
                },
                {
                    sightWord: 'am',
                    image: 'boy_playing.svg',
                    imageAlt: 'A boy playing',
                    sentence: 'I am playing.',
                    question: 'Which word goes with I?',
                    correctAnswer: 'am',
                    options: ['am', 'is', 'on']
                },

                // Lesson 6: "an"
                {
                    sightWord: 'an',
                    image: 'apple.svg',
                    imageAlt: 'An apple',
                    sentence: 'I have an apple.',
                    question: 'Which word goes before apple?',
                    correctAnswer: 'an',
                    options: ['an', 'am', 'on']
                },
                {
                    sightWord: 'an',
                    image: 'apple.svg',
                    imageAlt: 'An orange',
                    sentence: 'This is an orange.',
                    question: 'Which word comes before orange?',
                    correctAnswer: 'an',
                    options: ['an', 'am', 'is']
                }
            ]
        };

        // ========================================
        // GAME STATE
        // ========================================

        const gameState = {
            currentMode: 'teaching', // 'teaching', 'practice', 'summary'
            currentIndex: 0,
            isMuted: false,
            progress: {
                attempted: 0,
                correct: 0,
                wordStats: {}
            }
        };

        // Initialize word stats
        gameData.sightWords.forEach(word => {
            gameState.progress.wordStats[word] = { correct: 0, total: 0 };
        });

        // ========================================
        // DOM ELEMENTS
        // ========================================

        const mainContent = document.getElementById('mainContent');
        const teachingModeBtn = document.getElementById('teachingModeBtn');
        const practiceModeBtn = document.getElementById('practiceModeBtn');
        const summaryModeBtn = document.getElementById('summaryModeBtn');
        const muteBtn = document.getElementById('muteBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const feedbackOverlay = document.getElementById('feedbackOverlay');
        const feedbackEmoji = document.getElementById('feedbackEmoji');
        const feedbackText = document.getElementById('feedbackText');
        const ariaLive = document.getElementById('ariaLive');
        const confettiCanvas = document.getElementById('confettiCanvas');

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function announceToScreenReader(message) {
            ariaLive.textContent = message;
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function highlightSightWords(sentence, sightWords) {
            let highlighted = sentence;
            sightWords.forEach(word => {
                const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="sight-word">$1</span>');
            });
            return highlighted;
        }

        function saveProgress() {
            try {
                localStorage.setItem('sightWordsProgress', JSON.stringify(gameState.progress));
            } catch (e) {
                console.warn('Could not save progress to localStorage:', e);
            }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('sightWordsProgress');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    gameState.progress = { ...gameState.progress, ...parsed };
                }
            } catch (e) {
                console.warn('Could not load progress from localStorage:', e);
            }
        }

        // ========================================
        // TEXT-TO-SPEECH (Indian English Female Voice)
        // ========================================

        let speechSynthesis = window.speechSynthesis;
        let voices = [];

        function loadVoices() {
            voices = speechSynthesis.getVoices();
            console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
        }

        // Load voices (may need to wait for them to be ready)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function speakText(text) {
            if (gameState.isMuted) return;

            // Cancel any ongoing speech
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);

            // Try to find Indian English female voice
            let selectedVoice = voices.find(v =>
                v.lang.startsWith('en-IN') && v.name.toLowerCase().includes('female')
            );

            // Fallback to any Indian English voice
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith('en-IN'));
            }

            // Fallback to any English female voice
            if (!selectedVoice) {
                selectedVoice = voices.find(v =>
                    v.lang.startsWith('en') && v.name.toLowerCase().includes('female')
                );
            }

            // Fallback to any English voice
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith('en'));
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
                console.log('Using voice:', selectedVoice.name);
            }

            // Settings for child-friendly pace
            utterance.rate = 0.8;  // Slower pace
            utterance.pitch = 1.1; // Slightly higher pitch
            utterance.volume = 1.0;

            speechSynthesis.speak(utterance);

            // Announce to screen reader
            announceToScreenReader(text);
        }

        // ========================================
        // SOUND EFFECTS (WebAudio API)
        // ========================================

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSuccessSound() {
            if (gameState.isMuted) return;

            // Create a cheerful "ding" sound
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function playFailSound() {
            if (gameState.isMuted) return;

            // Create a gentle "try again" sound
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // ========================================
        // CONFETTI ANIMATION
        // ========================================

        class ConfettiParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * -15 - 10;
                this.speedX = Math.random() * 10 - 5;
                this.color = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'][Math.floor(Math.random() * 6)];
                this.gravity = 0.5;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 10 - 5;
            }

            update() {
                this.speedY += this.gravity;
                this.x += this.speedX;
                this.y += this.speedY;
                this.rotation += this.rotationSpeed;
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                ctx.restore();
            }
        }

        let confettiParticles = [];
        let confettiAnimationId = null;

        function createConfetti() {
            const canvas = confettiCanvas;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            confettiParticles = [];
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            for (let i = 0; i < 100; i++) {
                confettiParticles.push(new ConfettiParticle(centerX, centerY));
            }

            animateConfetti();
        }

        function animateConfetti() {
            const canvas = confettiCanvas;
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            confettiParticles = confettiParticles.filter(particle => {
                particle.update();
                particle.draw(ctx);
                return particle.y < canvas.height + 10;
            });

            if (confettiParticles.length > 0) {
                confettiAnimationId = requestAnimationFrame(animateConfetti);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // ========================================
        // TEACHING MODE
        // ========================================

        function renderTeachingMode() {
            const lesson = gameData.lessons[gameState.currentIndex];
            const totalLessons = gameData.lessons.length;

            mainContent.innerHTML = `
                <div class="teaching-view">
                    <div class="progress-indicator">
                        ${gameState.currentIndex + 1} / ${totalLessons}
                    </div>

                    <div class="image-container">
                        <img src="${lesson.image}" alt="${lesson.imageAlt}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="image-placeholder" style="display:none;">
                            üì∑ ${lesson.imageAlt}<br>
                            <small style="font-size: 14px; color: #999;">(Replace with ${lesson.image})</small>
                        </div>
                    </div>

                    <div class="sentence-container">
                        <div class="sentence-text">
                            ${highlightSightWords(lesson.sentence, gameData.sightWords)}
                        </div>
                        <div class="audio-controls">
                            <button class="btn-audio" id="playBtn" aria-label="Play sentence">
                                üîä
                            </button>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button class="btn-nav" id="prevBtn" aria-label="Previous lesson"
                                ${gameState.currentIndex === 0 ? 'disabled' : ''}>
                            ‚óÄ
                        </button>
                        <button class="btn-nav" id="nextBtn" aria-label="Next lesson"
                                ${gameState.currentIndex === totalLessons - 1 ? 'disabled' : ''}>
                            ‚ñ∂
                        </button>
                    </div>
                </div>
            `;

            // Attach event listeners
            document.getElementById('playBtn').addEventListener('click', () => {
                speakText(lesson.sentence);
            });

            const prevBtn = document.getElementById('prevBtn');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (gameState.currentIndex > 0) {
                        gameState.currentIndex--;
                        renderTeachingMode();
                    }
                });
            }

            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (gameState.currentIndex < totalLessons - 1) {
                        gameState.currentIndex++;
                        renderTeachingMode();
                    }
                });
            }

            // Auto-play on load
            setTimeout(() => speakText(lesson.sentence), 500);
        }

        // ========================================
        // PRACTICE MODE
        // ========================================

        function renderPracticeMode() {
            const lesson = gameData.lessons[gameState.currentIndex];
            const totalLessons = gameData.lessons.length;

            // Shuffle options
            const shuffledOptions = shuffleArray(lesson.options);

            mainContent.innerHTML = `
                <div class="practice-view">
                    <div class="progress-indicator">
                        Question ${gameState.currentIndex + 1} / ${totalLessons}
                    </div>

                    <div class="image-container">
                        <img src="${lesson.image}" alt="${lesson.imageAlt}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="image-placeholder" style="display:none;">
                            üì∑ ${lesson.imageAlt}<br>
                            <small style="font-size: 14px; color: #999;">(Replace with ${lesson.image})</small>
                        </div>
                    </div>

                    <div class="question-container">
                        <div class="question-text">
                            ${lesson.question}
                        </div>
                    </div>

                    <div class="options-container" id="optionsContainer">
                        ${shuffledOptions.map(option => `
                            <button class="option-btn" data-answer="${option}" aria-label="Answer: ${option}">
                                ${option}
                            </button>
                        `).join('')}
                    </div>

                    <div class="navigation-buttons" style="margin-top: 20px;">
                        <button class="btn-nav" id="skipBtn" aria-label="Skip to next question">
                            ‚è≠
                        </button>
                    </div>
                </div>
            `;

            // Attach event listeners to options
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach(btn => {
                btn.addEventListener('click', () => handleAnswer(btn, lesson));
            });

            // Skip button
            document.getElementById('skipBtn').addEventListener('click', () => {
                if (gameState.currentIndex < totalLessons - 1) {
                    gameState.currentIndex++;
                    renderPracticeMode();
                } else {
                    switchMode('summary');
                }
            });

            // Auto-speak question
            setTimeout(() => speakText(lesson.question), 500);
        }

        function handleAnswer(btn, lesson) {
            const selectedAnswer = btn.dataset.answer;
            const isCorrect = selectedAnswer === lesson.correctAnswer;

            // Disable all buttons
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            // Update progress
            gameState.progress.attempted++;
            if (isCorrect) {
                gameState.progress.correct++;
            }

            // Update word-specific stats
            const word = lesson.sightWord;
            gameState.progress.wordStats[word].total++;
            if (isCorrect) {
                gameState.progress.wordStats[word].correct++;
            }

            saveProgress();

            if (isCorrect) {
                // Correct answer
                btn.classList.add('correct');
                playSuccessSound();
                createConfetti();
                showFeedback('üòä', 'Great job, Jammy!', 'correct');
                announceToScreenReader('Correct! Great job!');

                // Auto-advance after 1.6s
                setTimeout(() => {
                    if (gameState.currentIndex < gameData.lessons.length - 1) {
                        gameState.currentIndex++;
                        renderPracticeMode();
                    } else {
                        switchMode('summary');
                    }
                }, 1600);
            } else {
                // Wrong answer
                btn.classList.add('incorrect');
                playFailSound();
                announceToScreenReader('Try again! The correct answer is ' + lesson.correctAnswer);

                // Show correct answer after 800ms
                setTimeout(() => {
                    allBtns.forEach(b => {
                        if (b.dataset.answer === lesson.correctAnswer) {
                            b.classList.add('correct');
                        }
                    });

                    // Auto-advance after showing correct answer
                    setTimeout(() => {
                        if (gameState.currentIndex < gameData.lessons.length - 1) {
                            gameState.currentIndex++;
                            renderPracticeMode();
                        } else {
                            switchMode('summary');
                        }
                    }, 1500);
                }, 800);
            }
        }

        function showFeedback(emoji, text, type) {
            feedbackEmoji.textContent = emoji;
            feedbackText.textContent = text;
            feedbackOverlay.classList.add('show');

            if (type === 'correct') {
                setTimeout(() => {
                    feedbackOverlay.classList.remove('show');
                }, 1500);
            }
        }

        // ========================================
        // SUMMARY MODE
        // ========================================

        function renderSummaryMode() {
            const { attempted, correct, wordStats } = gameState.progress;
            const percentage = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;

            let wordStatsHTML = '';
            for (const [word, stats] of Object.entries(wordStats)) {
                if (stats.total > 0) {
                    const wordPercentage = Math.round((stats.correct / stats.total) * 100);
                    wordStatsHTML += `
                        <div class="summary-stats">
                            <strong>${word}</strong>: ${stats.correct} / ${stats.total} (${wordPercentage}%)
                        </div>
                    `;
                }
            }

            mainContent.innerHTML = `
                <div class="summary-view">
                    <div class="summary-card">
                        <div class="summary-title">üéâ Progress Report üéâ</div>
                        <div class="summary-stats">
                            You answered <strong>${correct}</strong> out of <strong>${attempted}</strong> questions correctly!
                        </div>
                        <div class="summary-stats">
                            That's <strong>${percentage}%</strong>!
                        </div>
                        ${wordStatsHTML ? '<hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">' : ''}
                        ${wordStatsHTML}
                        <button class="btn-large" id="restartBtn">
                            üîÑ Practice Again
                        </button>
                        <button class="btn-large" id="clearProgressBtn" style="background: #f44336; margin-top: 10px;">
                            üóëÔ∏è Clear Progress
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('restartBtn').addEventListener('click', () => {
                gameState.currentIndex = 0;
                switchMode('teaching');
            });

            document.getElementById('clearProgressBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all progress?')) {
                    gameState.progress = {
                        attempted: 0,
                        correct: 0,
                        wordStats: {}
                    };
                    gameData.sightWords.forEach(word => {
                        gameState.progress.wordStats[word] = { correct: 0, total: 0 };
                    });
                    saveProgress();
                    renderSummaryMode();
                }
            });
        }

        // ========================================
        // MODE SWITCHING
        // ========================================

        function switchMode(mode) {
            gameState.currentMode = mode;

            // Update button styles
            teachingModeBtn.classList.toggle('active', mode === 'teaching');
            practiceModeBtn.classList.toggle('active', mode === 'practice');
            summaryModeBtn.classList.toggle('active', mode === 'summary');

            // Render appropriate view
            switch (mode) {
                case 'teaching':
                    renderTeachingMode();
                    break;
                case 'practice':
                    renderPracticeMode();
                    break;
                case 'summary':
                    renderSummaryMode();
                    break;
            }
        }

        // ========================================
        // CONTROL BUTTONS
        // ========================================

        teachingModeBtn.addEventListener('click', () => switchMode('teaching'));
        practiceModeBtn.addEventListener('click', () => switchMode('practice'));
        summaryModeBtn.addEventListener('click', () => switchMode('summary'));

        muteBtn.addEventListener('click', () => {
            gameState.isMuted = !gameState.isMuted;
            muteBtn.textContent = gameState.isMuted ? 'üîá' : 'üîä';
            announceToScreenReader(gameState.isMuted ? 'Sound muted' : 'Sound enabled');
        });

        fullscreenBtn.addEventListener('click', () => {
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                announceToScreenReader('Entered fullscreen mode');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                announceToScreenReader('Exited fullscreen mode');
            }
        });

        // Update fullscreen button on fullscreen change
        document.addEventListener('fullscreenchange', () => {
            fullscreenBtn.textContent = document.fullscreenElement ? '‚õ∂' : '‚õ∂';
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        function init() {
            console.log('üéÆ Sight Words Game Initialized');
            console.log('üìö Total lessons:', gameData.lessons.length);
            console.log('üî§ Sight words:', gameData.sightWords.join(', '));

            // Load saved progress
            loadProgress();

            // Start in teaching mode
            switchMode('teaching');

            // Enable audio context on first user interaction
            document.body.addEventListener('click', () => {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });

            // Handle window resize for confetti canvas
            window.addEventListener('resize', () => {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            });
        }

        // Start the game when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
